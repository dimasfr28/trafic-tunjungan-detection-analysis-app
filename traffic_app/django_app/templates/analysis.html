{% extends 'base.html' %}

{% block title %}Traffic Analysis{% endblock %}

{% block content %}
<div class="analysis-container">
    <h1 class="page-title">Traffic Analysis</h1>
    <p class="page-subtitle">Analisis lalu lintas berdasarkan data historis Jl. Tunjungan Surabaya</p>

    <!-- Metrics Cards -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9L18 10l-2-4H8L6 10l-2.5 1.1C2.7 11.3 2 12.1 2 13v3c0 .6.4 1 1 1h2"/>
                    <circle cx="7" cy="17" r="2"/>
                    <circle cx="17" cy="17" r="2"/>
                </svg>
            </div>
            <div class="metric-content">
                <h3>Average Vehicle Count</h3>
                <p class="metric-subtitle">Per Nearest Time Period</p>
                <span class="metric-value" id="avgVehicle">--</span>
                <span class="metric-label" id="avgVehicleLabel">kendaraan</span>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
            </div>
            <div class="metric-content">
                <h3>Peak Hour Range</h3>
                <p class="metric-subtitle">Jam Puncak Kemacetan</p>
                <span class="metric-value" id="peakHour">--</span>
                <span class="metric-label">cluster tinggi</span>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
            </div>
            <div class="metric-content">
                <h3>Peak Day</h3>
                <p class="metric-subtitle">Hari Paling Padat</p>
                <span class="metric-value" id="peakDay">--</span>
                <span class="metric-label">cluster dominan tertinggi</span>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 18V6l-5 4"/>
                    <circle cx="16" cy="10" r="3"/>
                    <circle cx="16" cy="18" r="3"/>
                    <line x1="16" y1="13" x2="16" y2="15"/>
                </svg>
            </div>
            <div class="metric-content">
                <h3>Dominant Vehicle Type</h3>
                <p class="metric-subtitle">For Nearest Time Period</p>
                <span class="metric-value" id="dominantVehicle">--</span>
                <span class="metric-label" id="dominantPct">--%</span>
            </div>
        </div>
    </div>

    <!-- Day Selector -->
    <div class="day-selector">
        <label for="daySelect">Pilih Hari:</label>
        <select id="daySelect">
            <option value="Monday">Monday</option>
            <option value="Tuesday">Tuesday</option>
            <option value="Wednesday">Wednesday</option>
            <option value="Thursday">Thursday</option>
            <option value="Friday">Friday</option>
            <option value="Saturday">Saturday</option>
            <option value="Sunday">Sunday</option>
        </select>
    </div>

    <!-- Charts Row 1: Traffic Density (8 cols) + Cluster Distribution (4 cols) -->
    <div class="row charts-row g-3">
        <div class="col-12 col-lg-8">
            <div class="chart-card">
                <h3>Traffic Density per Jam</h3>
                <div style="position: relative;">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <div class="chart-card">
                <h3>Cluster Distribution</h3>
                <div style="position: relative;">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2: Total Vehicles (4 cols) + Heatmap (8 cols) -->
    <div class="row charts-row g-3">
        <div class="col-12 col-lg-4">
            <div class="chart-card">
                <h3>Total Vehicles per Day</h3>
                <div style="position: relative;">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-8">
            <div class="chart-card">
                <h3>Traffic Intensity Heatmap (Hari x Jam)</h3>
                <div class="heatmap-container">
                    <canvas id="heatmapChart"></canvas>
                </div>
                <div class="heatmap-legend">
                    <span class="legend-item"><span class="legend-color low"></span> Low (1)</span>
                    <span class="legend-item"><span class="legend-color medium"></span> Medium (2)</span>
                    <span class="legend-item"><span class="legend-color high"></span> High (3)</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let lineChart, pieChart, barChart, heatmapChart;

    // Get current day
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const today = days[new Date().getDay()];
    document.getElementById('daySelect').value = today;

    // Load metrics
    async function loadMetrics() {
        try {
            const response = await fetch('/api/metrics/');
            const data = await response.json();

            if (data.success) {
                const m = data.metrics;
                document.getElementById('avgVehicle').textContent = m.avg_vehicle_count;
                document.getElementById('avgVehicleLabel').textContent = `per ${m.current_time_bucket}`;
                document.getElementById('peakHour').textContent = m.peak_hour_range;
                document.getElementById('peakDay').textContent = m.peak_day;
                document.getElementById('dominantVehicle').textContent = m.dominant_vehicle_type;
                document.getElementById('dominantPct').textContent = `${m.dominant_vehicle_pct}%`;
            }
        } catch (error) {
            console.error('Error loading metrics:', error);
        }
    }

    // Load chart data
    async function loadChartData(day) {
        try {
            const response = await fetch(`/api/chart-data/?day=${day}`);
            const data = await response.json();

            if (data.success) {
                updateLineChart(data.line_chart);
                updatePieChart(data.pie_chart);
                updateBarChart(data.bar_chart);
                updateHeatmap(data.heatmap);
            }
        } catch (error) {
            console.error('Error loading chart data:', error);
        }
    }

    function updateLineChart(chartData) {
        const ctx = document.getElementById('lineChart').getContext('2d');

        if (lineChart) lineChart.destroy();

        lineChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: 'Car',
                        data: chartData.datasets.car,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.4
                    },
                    {
                        label: 'Motorcycle',
                        data: chartData.datasets.motorcycle,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.4
                    },
                    {
                        label: 'Heavy Vehicle',
                        data: chartData.datasets.heavy,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2.4,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    function updatePieChart(chartData) {
        const ctx = document.getElementById('pieChart').getContext('2d');

        if (pieChart) pieChart.destroy();

        pieChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: chartData.labels,
                datasets: [{
                    data: chartData.data,
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(255, 99, 132, 0.8)'
                    ],
                    borderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    function updateBarChart(chartData) {
        const ctx = document.getElementById('barChart').getContext('2d');

        if (barChart) barChart.destroy();

        barChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: 'Car',
                        data: chartData.datasets.car,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)'
                    },
                    {
                        label: 'Motorcycle',
                        data: chartData.datasets.motorcycle,
                        backgroundColor: 'rgba(75, 192, 192, 0.8)'
                    },
                    {
                        label: 'Heavy',
                        data: chartData.datasets.heavy,
                        backgroundColor: 'rgba(255, 99, 132, 0.8)'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1.1,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    x: { stacked: true },
                    y: { stacked: true, beginAtZero: true }
                }
            }
        });
    }

    function updateHeatmap(heatmapData) {
        const canvas = document.getElementById('heatmapChart');
        const container = canvas.parentElement;
        const ctx = canvas.getContext('2d');

        // Set canvas size based on container
        const dpr = window.devicePixelRatio || 1;
        const rect = container.getBoundingClientRect();

        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        canvas.style.width = rect.width + 'px';
        canvas.style.height = rect.height + 'px';

        ctx.scale(dpr, dpr);

        // Calculate dimensions
        const padding = { top: 30, right: 20, bottom: 30, left: 60 };
        const width = rect.width - padding.left - padding.right;
        const height = rect.height - padding.top - padding.bottom;

        const cellWidth = width / 24;
        const cellHeight = height / 7;

        // Clear canvas
        ctx.clearRect(0, 0, rect.width, rect.height);

        // Draw cells
        heatmapData.data.forEach(cell => {
            const x = padding.left + cell.x * cellWidth;
            const y = padding.top + cell.y * cellHeight;

            // Color based on cluster
            let color;
            if (cell.cluster === 3) {
                color = `rgba(255, 99, 132, ${0.5 + Math.min(cell.value / 300, 0.5)})`;
            } else if (cell.cluster === 2) {
                color = `rgba(255, 206, 86, ${0.5 + Math.min(cell.value / 300, 0.5)})`;
            } else {
                color = `rgba(75, 192, 192, ${0.3 + Math.min(cell.value / 300, 0.5)})`;
            }

            ctx.fillStyle = color;
            ctx.fillRect(x, y, cellWidth - 2, cellHeight - 2);

            // Add border
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.strokeRect(x, y, cellWidth - 2, cellHeight - 2);
        });

        // Draw labels
        ctx.fillStyle = '#94a3b8';
        ctx.font = '11px Inter, Arial, sans-serif';
        ctx.textAlign = 'center';

        // X labels (hours) - show every 2 hours
        heatmapData.xLabels.forEach((label, i) => {
            if (i % 2 === 0) {
                const x = padding.left + i * cellWidth + cellWidth / 2;
                const y = rect.height - 10;
                ctx.fillText(label, x, y);
            }
        });

        // Y labels (days)
        ctx.textAlign = 'right';
        ctx.font = '12px Inter, Arial, sans-serif';
        heatmapData.yLabels.forEach((label, i) => {
            const x = padding.left - 10;
            const y = padding.top + i * cellHeight + cellHeight / 2 + 4;
            ctx.fillText(label.substring(0, 3), x, y);
        });
    }

    // Resize heatmap on window resize
    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
            const daySelect = document.getElementById('daySelect');
            if (daySelect) {
                loadChartData(daySelect.value);
            }
        }, 250);
    });

    // Event listeners
    document.getElementById('daySelect').addEventListener('change', function() {
        loadChartData(this.value);
    });

    // Initialize
    loadMetrics();
    loadChartData(today);
});
</script>
{% endblock %}
