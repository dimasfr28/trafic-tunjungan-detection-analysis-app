{% extends 'base.html' %}

{% block title %}Prediction - Traffic Analysis{% endblock %}

{% block content %}
<div class="prediction-container">
    <h1 class="page-title">Traffic Prediction</h1>
    <p class="page-subtitle">Upload video untuk analisis prediksi lalu lintas menggunakan YOLO</p>

    <div class="prediction-grid">
        <!-- Left Panel: Input -->
        <div class="input-panel">
            <h2>Input Parameters</h2>

            <form id="predictionForm" class="prediction-form">
                <div class="form-group">
                    <label for="predictionDate">Tanggal</label>
                    <input type="date" id="predictionDate" name="date" required>
                </div>

                <div class="form-group">
                    <label for="predictionHour">Jam</label>
                    <select id="predictionHour" name="hour" required>
                        {% for h in "0123456789101112131415161718192021222324"|make_list %}
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="videoFile">Upload Video</label>
                    <div class="file-upload">
                        <input type="file" id="videoFile" name="file" accept="video/*" required>
                        <div class="file-upload-label">
                            <span class="upload-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                            </span>
                            <span class="upload-text">Pilih file video atau drag & drop</span>
                            <span class="upload-hint">MP4, AVI, MOV (Max 500MB)</span>
                        </div>
                    </div>
                    <p class="file-name" id="fileName"></p>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-full" id="processBtn">
                        Process Video
                    </button>
                </div>
            </form>

            <div class="processing-status" id="processingStatus" style="display: none;">
                <div class="spinner"></div>
                <p>Memproses video dengan YOLO detection...</p>
                <p class="status-detail" id="statusDetail">Initializing...</p>
            </div>

            <div class="prediction-results" id="predictionResults" style="display: none;">
                <h3>Detection Results Per Minute</h3>
                <p class="results-summary">
                    Total: <span id="totalMinutes">0</span> menit |
                    <span id="totalCar">0</span> Car,
                    <span id="totalMotorcycle">0</span> Motorcycle,
                    <span id="totalHeavy">0</span> Heavy |
                    Frames: <span id="resultFrames">0</span>
                </p>

                <div class="results-table-container">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Waktu</th>
                                <th>Car</th>
                                <th>Motor</th>
                                <th>Heavy</th>
                                <th>Total</th>
                                <th>Kepadatan (DNN)</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right Panel: Output Video -->
        <div class="output-panel">
            <h2>Output Video</h2>

            <div class="video-output-container">
                <div class="video-placeholder" id="videoPlaceholder">
                    <span class="placeholder-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="23 7 16 12 23 17 23 7"/>
                            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                        </svg>
                    </span>
                    <p>Video hasil prediksi akan ditampilkan di sini</p>
                    <p class="placeholder-hint">Upload dan proses video terlebih dahulu</p>
                </div>

                <div class="video-wrapper" id="videoOutput" style="display: none;">
                    <img id="outputStream" src="" alt="Output Video" class="video-frame">
                </div>
            </div>

            <div class="video-controls output-controls" id="outputControls" style="display: none;">
                <button class="btn btn-sm" id="replayBtn">Replay</button>
                <span class="video-info">Processed Video</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('predictionForm');
    const fileInput = document.getElementById('videoFile');
    const fileName = document.getElementById('fileName');
    const processBtn = document.getElementById('processBtn');
    const processingStatus = document.getElementById('processingStatus');
    const statusDetail = document.getElementById('statusDetail');
    const predictionResults = document.getElementById('predictionResults');
    const videoPlaceholder = document.getElementById('videoPlaceholder');
    const videoOutput = document.getElementById('videoOutput');
    const outputStream = document.getElementById('outputStream');
    const outputControls = document.getElementById('outputControls');
    const hourSelect = document.getElementById('predictionHour');

    // Populate hour select
    for (let h = 0; h < 24; h++) {
        const option = document.createElement('option');
        option.value = h;
        option.textContent = `${String(h).padStart(2, '0')}:00`;
        hourSelect.appendChild(option);
    }

    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('predictionDate').value = today;
    hourSelect.value = new Date().getHours();

    // File input handler
    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            fileName.textContent = this.files[0].name;
        } else {
            fileName.textContent = '';
        }
    });

    // Drag and drop
    const fileUpload = document.querySelector('.file-upload');
    fileUpload.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });
    fileUpload.addEventListener('dragleave', function() {
        this.classList.remove('dragover');
    });
    fileUpload.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) {
            fileInput.files = e.dataTransfer.files;
            fileName.textContent = e.dataTransfer.files[0].name;
        }
    });

    // Form submit
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        if (!fileInput.files.length) {
            alert('Pilih file video terlebih dahulu');
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('date', document.getElementById('predictionDate').value);
        formData.append('hour', hourSelect.value);

        // Show processing status
        processBtn.disabled = true;
        processingStatus.style.display = 'block';
        predictionResults.style.display = 'none';

        try {
            statusDetail.textContent = 'Uploading & Processing with YOLO detection...';

            // Start fetch - upload is fast, processing takes time
            const response = await fetch('http://localhost:8002/api/predict', {
                method: 'POST',
                body: formData
            });

            statusDetail.textContent = 'Finalizing results...';

            const data = await response.json();

            if (data.success) {
                // Show results
                predictionResults.style.display = 'block';

                // Update summary
                document.getElementById('totalMinutes').textContent = data.total_minutes || 0;
                document.getElementById('totalCar').textContent = data.total_counts.car || 0;
                document.getElementById('totalMotorcycle').textContent = data.total_counts.motorcycle || 0;
                document.getElementById('totalHeavy').textContent = data.total_counts.heavy || 0;
                document.getElementById('resultFrames').textContent = data.frames_processed;

                // Build table rows for per-minute results
                const tableBody = document.getElementById('resultsTableBody');
                tableBody.innerHTML = '';

                if (data.results_per_minute && data.results_per_minute.length > 0) {
                    data.results_per_minute.forEach((result, index) => {
                        const row = document.createElement('tr');
                        const total = (result.counts.car || 0) + (result.counts.motorcycle || 0) + (result.counts.heavy || 0);

                        // Get density class for styling based on label
                        // Class mapping from notebook:
                        // 1 = Lancar (Low/Smooth) -> Green
                        // 2 = Macet (High/Congested) -> Red
                        // 3 = Padat (Medium/Dense) -> Yellow
                        let densityClass = 'density-lancar';
                        const label = result.prediction.label.toLowerCase();
                        if (label === 'macet') densityClass = 'density-macet';
                        else if (label === 'padat') densityClass = 'density-padat';

                        row.innerHTML = `
                            <td>${result.time}</td>
                            <td>${result.counts.car || 0}</td>
                            <td>${result.counts.motorcycle || 0}</td>
                            <td>${result.counts.heavy || 0}</td>
                            <td><strong>${total}</strong></td>
                            <td>
                                <span class="density-badge ${densityClass}">
                                    ${result.prediction.label}
                                    <small>(${Math.round(result.prediction.confidence * 100)}%)</small>
                                </span>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No per-minute data available</td></tr>';
                }

                // Show model status warning if model failed to load
                if (!data.model_loaded) {
                    alert('Warning: YOLO model failed to load. Detection results may be inaccurate. Check server logs for details.');
                }

                // Show output video with slight delay to ensure file is ready
                setTimeout(() => {
                    videoPlaceholder.style.display = 'none';
                    videoOutput.style.display = 'block';
                    outputControls.style.display = 'flex';
                    // Reset videoOutput content in case of previous error
                    videoOutput.innerHTML = '<img id="outputStream" src="" alt="Output Video" class="video-frame">';
                    // Re-get the element after resetting
                    const newOutputStream = document.getElementById('outputStream');
                    newOutputStream.src = 'http://localhost:8002/api/predict/stream?' + Date.now();
                }, 500);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Error processing video: ' + error.message);
        } finally {
            processBtn.disabled = false;
            processingStatus.style.display = 'none';
        }
    });

    // Replay button
    document.getElementById('replayBtn').addEventListener('click', function() {
        loadOutputStream();
    });

    // Stream loading with retry
    let retryCount = 0;
    const maxRetries = 3;

    function loadOutputStream() {
        retryCount = 0;
        outputStream.onerror = null;
        outputStream.onload = null;

        outputStream.onload = function() {
            console.log('Stream loaded successfully');
            retryCount = 0;
        };

        outputStream.onerror = function() {
            console.error('Stream error, retry:', retryCount);
            if (retryCount < maxRetries) {
                retryCount++;
                setTimeout(() => {
                    outputStream.src = 'http://localhost:8002/api/predict/stream?' + Date.now();
                }, 1000);
            } else {
                videoOutput.innerHTML = '<p class="stream-error">Failed to load video stream after ' + maxRetries + ' retries. Please click Replay to try again.</p>';
            }
        };

        outputStream.src = 'http://localhost:8002/api/predict/stream?' + Date.now();
    }

    // Initial load function for after prediction
    window.loadPredictionStream = loadOutputStream;
});
</script>
{% endblock %}
